<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.1.0">

    <!--
    JPA Configuration
    -->
    <bean id="policyRepository" class="com.gafri.example.transaction.domain.repository.impl.JpaPolicyRepository">
        <jpa:unit property="entityManagerFactory" unitname="example"/>
    </bean>

    <bean id="jpaTransactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
        <jpa:unit property="entityManagerFactory" unitname="example"/>
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <reference id="dataSource" interface="javax.sql.DataSource" filter="(databaseName=EXAMPLE)"
               availability="mandatory"/>

    <!--
    JMS Configuration
    -->
    <reference id="connectionFactory" interface="javax.jms.ConnectionFactory" availability="mandatory"/>

    <bean id="jmsTransactionManager" class="org.springframework.jms.connection.JmsTransactionManager">
        <property name="connectionFactory" ref="connectionFactory"/>
    </bean>

    <bean id="jms" class="org.apache.camel.component.jms.JmsComponent">
        <property name="connectionFactory" ref="connectionFactory"/>
        <property name="transacted" value="true"/>
        <property name="transactionManager" ref="jmsTransactionManager"/>
    </bean>

    <!--
    Camel Configuration
    -->
    <camelContext id="blueprintContext" xmlns="http://camel.apache.org/schema/blueprint">
        <routeBuilder ref="newPolicyRoute"/>
        <route id="fileInput">
            <from uri="file:data/inbox/policy" />
            <to uri="jms:queue:ADD_POLICY" />
        </route>
    </camelContext>

    <bean id="newPolicyRoute" class="com.gafri.example.transaction.route.NewPolicyRouteBuilder"/>

    <bean id="TX_REQUIRED" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
        <property name="transactionManager" ref="jpaTransactionManager"/>
    </bean>

</blueprint>
